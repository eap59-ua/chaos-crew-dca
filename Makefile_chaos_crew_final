# ============================================================================
# Makefile para Chaos Crew - Arquitectura ECS
# ============================================================================
# Equipo: 5 integrantes
# Asignatura: Desarrollo Colaborativo de Aplicaciones (DCA)
# Universidad de Alicante - 2025
# ============================================================================

.PHONY: all clean info clean-cache dev-deps install uninstall dist run debug help

# ============================================================================
# Colors para output terminal
# ============================================================================
RED    := \033[0;31m
GREEN  := \033[0;32m
YELLOW := \033[1;33m
BLUE   := \033[0;34m
CYAN   := \033[0;36m
NC     := \033[0m # No Color

# ============================================================================
# ConfiguraciÃ³n del compilador
# ============================================================================
CXX      := ccache g++
CXXFLAGS := -std=c++17 -Wall -Wextra -Wpedantic
OPTFLAGS := -O3
DBGFLAGS := -g -O0

# ============================================================================
# Estructura de directorios
# ============================================================================
SRC_DIR    := src
OBJ_DIR    := obj
BIN_DIR    := bin
LIB_DIR    := vendor/lib
INCLUDE    := vendor/include

# Subdirectorios con cÃ³digo fuente (.cpp)
# IMPORTANTE: No incluir 'components' ni 'entt' (solo headers)
SRC_SUBDIRS := core entities states systems

# Directorios de includes adicionales
INC_DIRS := -I$(SRC_DIR) \
            -I$(SRC_DIR)/components \
            -I$(SRC_DIR)/entt \
            -I$(INCLUDE)

# ============================================================================
# DetecciÃ³n automÃ¡tica de archivos fuente
# ============================================================================
# Encontrar todos los .cpp en los subdirectorios especificados
SOURCES := $(foreach dir,$(SRC_SUBDIRS),$(wildcard $(SRC_DIR)/$(dir)/*.cpp))
# AÃ±adir main.cpp si existe en raÃ­z de src/
SOURCES += $(wildcard $(SRC_DIR)/main.cpp)

# Generar nombres de objetos manteniendo estructura de directorios
OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(SOURCES))

# Archivos de dependencias automÃ¡ticas
DEPS := $(OBJECTS:.o=.d)

# Nombre del ejecutable
TARGET := $(BIN_DIR)/chaos-crew

# ============================================================================
# LibrerÃ­as
# ============================================================================
# Raylib y dependencias del sistema
LIBS := -lraylib -lGL -lm -lpthread -ldl -lrt -lX11

# Si tienes librerÃ­as adicionales en vendor/lib
ifneq ($(wildcard $(LIB_DIR)/*),)
    LDFLAGS += -L$(LIB_DIR)
endif

# ============================================================================
# Regla por defecto
# ============================================================================
all: banner $(TARGET) success

# ============================================================================
# Banner informativo
# ============================================================================
banner:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘$(NC)  $(GREEN)Compilando Chaos Crew (ECS)$(NC)       $(CYAN)â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

success:
	@echo ""
	@echo "$(GREEN)âœ… CompilaciÃ³n exitosa!$(NC)"
	@echo "$(YELLOW)ğŸ“ Ejecutable: $(TARGET)$(NC)"
	@echo "$(CYAN)â–¶ï¸  Ejecutar con: make run$(NC)"
	@echo ""

# ============================================================================
# CompilaciÃ³n del ejecutable
# ============================================================================
$(TARGET): $(OBJECTS)
	@echo "$(BLUE)ğŸ”— Linkeando ejecutable...$(NC)"
	@mkdir -p $(BIN_DIR)
	@$(CXX) $(OBJECTS) -o $@ $(LDFLAGS) $(LIBS)

# ============================================================================
# CompilaciÃ³n de archivos objeto (con dependencias automÃ¡ticas)
# ============================================================================
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@echo "$(YELLOW)ğŸ”¨ Compilando$(NC) $<"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(OPTFLAGS) $(INC_DIRS) -MMD -MP -c $< -o $@

# Incluir archivos de dependencias
-include $(DEPS)

# ============================================================================
# Reglas de limpieza
# ============================================================================
clean:
	@echo "$(RED)ğŸ§¹ Limpiando archivos de compilaciÃ³n...$(NC)"
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

clean-cache:
	@echo "$(RED)ğŸ§¹ Limpiando cachÃ© de ccache...$(NC)"
	@ccache -C
	@ccache -z
	@echo "$(GREEN)âœ… CachÃ© limpiada y estadÃ­sticas reseteadas$(NC)"

# ============================================================================
# CompilaciÃ³n en modo debug
# ============================================================================
debug: OPTFLAGS := $(DBGFLAGS)
debug: CXXFLAGS += -DDEBUG
debug: clean
	@echo "$(YELLOW)ğŸ› Compilando en modo DEBUG...$(NC)"
	@$(MAKE) --no-print-directory all

# ============================================================================
# Ejecutar el juego
# ============================================================================
run: all
	@echo "$(GREEN)ğŸ® Ejecutando Chaos Crew...$(NC)"
	@echo ""
	@./$(TARGET)

# ============================================================================
# InformaciÃ³n del proyecto
# ============================================================================
info:
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)   InformaciÃ³n del Proyecto Chaos Crew$(NC)"
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(YELLOW)Compilador:$(NC)     $(CXX)"
	@echo "$(YELLOW)Flags:$(NC)          $(CXXFLAGS) $(OPTFLAGS)"
	@echo "$(YELLOW)Archivos .cpp:$(NC)  $(words $(SOURCES))"
	@echo "$(YELLOW)Subdirectorios:$(NC) $(SRC_SUBDIRS)"
	@echo "$(YELLOW)Ejecutable:$(NC)     $(TARGET)"
	@echo "$(YELLOW)LibrerÃ­as:$(NC)      Raylib + EnTT (header-only)"
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(BLUE)ğŸ“Š EstadÃ­sticas ccache:$(NC)"
	@ccache -s | grep -E "(cache (hit|miss)|files in cache|cache size)" || echo "  ccache no disponible"
	@echo ""

# ============================================================================
# Verificar estructura de directorios
# ============================================================================
check-dirs:
	@echo "$(BLUE)ğŸ“‚ Verificando estructura de directorios...$(NC)"
	@for dir in $(SRC_SUBDIRS); do \
		if [ -d $(SRC_DIR)/$$dir ]; then \
			echo "  $(GREEN)âœ…$(NC) $(SRC_DIR)/$$dir"; \
		else \
			echo "  $(RED)âŒ$(NC) $(SRC_DIR)/$$dir (no existe)"; \
		fi \
	done
	@if [ -d $(SRC_DIR)/components ]; then \
		echo "  $(GREEN)âœ…$(NC) $(SRC_DIR)/components (headers)"; \
	fi
	@if [ -d $(SRC_DIR)/entt ]; then \
		echo "  $(GREEN)âœ…$(NC) $(SRC_DIR)/entt (librerÃ­a header-only)"; \
	fi

# ============================================================================
# Listar archivos fuente detectados
# ============================================================================
list-sources:
	@echo "$(BLUE)ğŸ“„ Archivos fuente detectados:$(NC)"
	@for src in $(SOURCES); do \
		echo "  - $$src"; \
	done
	@echo ""
	@echo "$(YELLOW)Total: $(words $(SOURCES)) archivos$(NC)"

# ============================================================================
# Dependencias de desarrollo (opcional)
# ============================================================================
dev-deps:
	@echo "$(BLUE)ğŸ“¦ Instalando dependencias de desarrollo...$(NC)"
	@command -v ccache >/dev/null 2>&1 || { \
		echo "$(YELLOW)Instalando ccache...$(NC)"; \
		sudo apt update && sudo apt install -y ccache; \
	}
	@command -v raylib >/dev/null 2>&1 || { \
		echo "$(YELLOW)Raylib no detectada. InstalaciÃ³n manual requerida.$(NC)"; \
		echo "Ver: https://github.com/raysan5/raylib"; \
	}
	@echo "$(GREEN)âœ… VerificaciÃ³n de dependencias completada$(NC)"

# ============================================================================
# InstalaciÃ³n del juego (copia a /usr/local/bin)
# ============================================================================
install: all
	@echo "$(BLUE)ğŸ“¦ Instalando Chaos Crew...$(NC)"
	@sudo install -d /usr/local/bin
	@sudo install -m 755 $(TARGET) /usr/local/bin/chaos-crew
	@echo "$(GREEN)âœ… Chaos Crew instalado en /usr/local/bin/chaos-crew$(NC)"
	@echo "$(CYAN)Ejecutar con: chaos-crew$(NC)"

uninstall:
	@echo "$(RED)ğŸ—‘ï¸  Desinstalando Chaos Crew...$(NC)"
	@sudo rm -f /usr/local/bin/chaos-crew
	@echo "$(GREEN)âœ… Chaos Crew desinstalado$(NC)"

# ============================================================================
# Crear tarball para distribuciÃ³n
# ============================================================================
dist: clean
	@echo "$(BLUE)ğŸ“¦ Creando tarball de distribuciÃ³n...$(NC)"
	@tar -czf chaos-crew-src.tar.gz \
		--exclude='*.o' \
		--exclude='*.d' \
		--exclude='bin/*' \
		--exclude='obj/*' \
		--exclude='.git' \
		--exclude='*.tar.gz' \
		--exclude='*.zip' \
		.
	@echo "$(GREEN)âœ… Tarball creado: chaos-crew-src.tar.gz$(NC)"

# ============================================================================
# AnÃ¡lisis de cÃ³digo (opcional)
# ============================================================================
analyze:
	@echo "$(BLUE)ğŸ” Analizando cÃ³digo con cppcheck...$(NC)"
	@command -v cppcheck >/dev/null 2>&1 && \
		cppcheck --enable=all --suppress=missingIncludeSystem \
		$(SRC_DIR) 2>&1 | tee cppcheck-report.txt || \
		echo "$(YELLOW)cppcheck no instalado. Usar: sudo apt install cppcheck$(NC)"

# ============================================================================
# Formateo de cÃ³digo (opcional)
# ============================================================================
format:
	@echo "$(BLUE)ğŸ¨ Formateando cÃ³digo con clang-format...$(NC)"
	@command -v clang-format >/dev/null 2>&1 && \
		find $(SRC_DIR) -name '*.cpp' -o -name '*.hpp' | \
		xargs clang-format -i -style=file || \
		echo "$(YELLOW)clang-format no instalado$(NC)"

# ============================================================================
# Testing (preparado para futura integraciÃ³n)
# ============================================================================
test:
	@echo "$(YELLOW)âš ï¸  Suite de tests aÃºn no implementada$(NC)"
	@echo "$(CYAN)TODO: Integrar GoogleTest o Catch2$(NC)"

# ============================================================================
# Benchmark de compilaciÃ³n
# ============================================================================
benchmark:
	@echo "$(BLUE)â±ï¸  Benchmark de compilaciÃ³n...$(NC)"
	@echo ""
	@echo "$(YELLOW)CompilaciÃ³n secuencial:$(NC)"
	@make clean > /dev/null 2>&1
	@time make -j1 > /dev/null 2>&1
	@echo ""
	@echo "$(YELLOW)CompilaciÃ³n paralela (-j4):$(NC)"
	@make clean > /dev/null 2>&1
	@time make -j4 > /dev/null 2>&1
	@echo ""

# ============================================================================
# Ayuda
# ============================================================================
help:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘$(NC)     $(GREEN)Makefile de Chaos Crew - Comandos Disponibles$(NC)    $(CYAN)â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ CompilaciÃ³n:$(NC)"
	@echo "  make              - Compila el proyecto (optimizado)"
	@echo "  make -j4          - Compila en paralelo (4 threads)"
	@echo "  make debug        - Compila en modo debug"
	@echo "  make clean        - Limpia archivos de compilaciÃ³n"
	@echo "  make clean-cache  - Limpia cachÃ© de ccache"
	@echo ""
	@echo "$(YELLOW)ğŸ® EjecuciÃ³n:$(NC)"
	@echo "  make run          - Compila y ejecuta el juego"
	@echo ""
	@echo "$(YELLOW)â„¹ï¸  InformaciÃ³n:$(NC)"
	@echo "  make info         - Muestra informaciÃ³n del proyecto"
	@echo "  make check-dirs   - Verifica estructura de directorios"
	@echo "  make list-sources - Lista archivos fuente detectados"
	@echo "  make help         - Muestra esta ayuda"
	@echo ""
	@echo "$(YELLOW)ğŸ› ï¸  Utilidades:$(NC)"
	@echo "  make dev-deps     - Instala dependencias de desarrollo"
	@echo "  make install      - Instala el juego en el sistema"
	@echo "  make uninstall    - Desinstala el juego"
	@echo "  make dist         - Crea tarball de distribuciÃ³n"
	@echo "  make analyze      - AnÃ¡lisis estÃ¡tico con cppcheck"
	@echo "  make format       - Formatea cÃ³digo con clang-format"
	@echo "  make benchmark    - Benchmark de compilaciÃ³n"
	@echo ""
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# ============================================================================
# InformaciÃ³n adicional
# ============================================================================
.DEFAULT_GOAL := all

# Mostrar comandos ejecutados (verbose mode)
# Descomentar la siguiente lÃ­nea para ver comandos:
# .SILENT:

# ============================================================================
# Notas para el equipo:
# ============================================================================
# 1. Este Makefile detecta automÃ¡ticamente archivos .cpp en subdirectorios
# 2. NO necesitas modificarlo al aÃ±adir nuevos archivos .cpp
# 3. EnTT es header-only, no necesita compilarse
# 4. Components son solo headers, no se compilan
# 5. Para compilar mÃ¡s rÃ¡pido: make -j4 (o -j8 segÃºn tu CPU)
# 6. Para depurar: make debug && gdb bin/chaos-crew
# ============================================================================

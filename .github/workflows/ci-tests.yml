name: Tests CI - P03

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # ===================================
      # PASO 1: Checkout del cÃ³digo
      # ===================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===================================
      # PASO 2: Instalar dependencias
      # ===================================
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libboost-test-dev \
            libentt-dev

      # ===================================
      # PASO 3: Debug (muy Ãºtil si algo falla)
      # ===================================
      - name: Debug workspace
        run: |
          echo "PWD:"; pwd
          echo "GITHUB_WORKSPACE:"; echo "$GITHUB_WORKSPACE"
          echo "Contenido del directorio actual:"
          ls -la
          echo "Contenido del workspace:"
          ls -la "$GITHUB_WORKSPACE" || true

      # ===================================
      # PASO 4: Configurar CMake (rutas absolutas)
      # ===================================
      - name: Configure CMake
        run: cmake -S "$GITHUB_WORKSPACE" -B "$GITHUB_WORKSPACE/build" -DCMAKE_BUILD_TYPE=Debug

      # ===================================
      # PASO 5: Compilar proyecto
      # ===================================
      - name: Build
        run: cmake --build "$GITHUB_WORKSPACE/build" --parallel

      # ===================================
      # PASO 6: Ejecutar tests (sin cd)
      # ===================================
      - name: Run tests
        run: ctest --test-dir "$GITHUB_WORKSPACE/build" --output-on-failure --verbose

      # ===================================
      # PASO 7: Generar reporte en el Summary
      # ===================================
      - name: Generate test report
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          ctest --test-dir "$GITHUB_WORKSPACE/build" --output-on-failure 2>&1 | tee "$GITHUB_WORKSPACE/build/test_results.txt"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat "$GITHUB_WORKSPACE/build/test_results.txt" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      # ===================================
      # PASO 8: Subir logs si falla (upload-artifact v4)
      # ===================================
      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
            ${{ github.workspace }}/build/test_results.txt
          retention-days: 7
          if-no-files-found: warn

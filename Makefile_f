# ============================================================================
# Makefile para Chaos Crew - Arquitectura ECS
# ============================================================================
# Equipo: 5 integrantes
# Asignatura: Desarrollo Colaborativo de Aplicaciones (DCA)
# Universidad de Alicante - 2025
# ============================================================================

.PHONY: all clean info clean-cache dev-deps install uninstall dist run debug help

#
RED    := \033[0;31m
GREEN  := \033[0;32m
YELLOW := \033[1;33m
BLUE   := \033[0;34m
CYAN   := \033[0;36m
NC     := \033[0m # No Color


CXX      := g++
CXXFLAGS := -std=c++17 -Wall -Wextra -Wpedantic
OPTFLAGS := -O3
DBGFLAGS := -g -O0


SRC_DIR    := src
OBJ_DIR    := obj
BIN_DIR    := bin
LIB_DIR    := vendor/lib
INCLUDE    := vendor/include

SRC_SUBDIRS := core entities states systems

# Directorios de includes adicionales
INC_DIRS := -I$(SRC_DIR) \
            -I$(SRC_DIR)/components \
            -I$(SRC_DIR)/entt \
            -I$(INCLUDE)

# ============================================================================
# DetecciÃ³n automÃ¡tica de archivos fuente
# ============================================================================
# Encontrar todos los .cpp en los subdirectorios especificados
SOURCES := $(foreach dir,$(SRC_SUBDIRS),$(wildcard $(SRC_DIR)/$(dir)/*.cpp))
# AÃ±adir main.cpp si existe en raÃ­z de src/
SOURCES += $(wildcard $(SRC_DIR)/main.cpp)

# Generar nombres de objetos manteniendo estructura de directorios
OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(SOURCES))

# Archivos de dependencias automÃ¡ticas
DEPS := $(OBJECTS:.o=.d)

# Nombre del ejecutable
TARGET := $(BIN_DIR)/game


# Raylib y dependencias del sistema
LIBS := -lraylib -lGL -lm -lpthread -ldl -lrt -lX11


# ============================================================================
# Regla por defecto
# ============================================================================
all: banner $(TARGET) success

# ============================================================================
# Banner informativo
# ============================================================================
banner:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘$(NC)  $(GREEN)Compilando Chaos Crew (ECS)$(NC)       $(CYAN)â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

success:
	@echo ""
	@echo "$(GREEN)âœ… CompilaciÃ³n exitosa!$(NC)"
	@echo "$(YELLOW)ğŸ“ Ejecutable: $(TARGET)$(NC)"
	@echo "$(CYAN)â–¶ï¸  Ejecutar con: make run$(NC)"
	@echo ""

# ============================================================================
# CompilaciÃ³n del ejecutable y  linkeado
# ============================================================================
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@echo "$(YELLOW)Compilando$(NC) $<"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(OPTFLAGS) $(INC_DIRS) -MMD -MP -c $< -o $@

$(TARGET): $(OBJECTS)
	@echo "$(BLUE)ğŸ”— Linkeando ejecutable...$(NC)"
	@mkdir -p $(BIN_DIR)
	@$(CXX) $(OBJECTS) -o $@ $(LDFLAGS) $(LIBS)


# Incluir archivos de dependencias
-include $(DEPS)

# ============================================================================
# Reglas de limpieza
# ============================================================================
clean:
	@echo "$(RED)ğŸ§¹ Limpiando archivos de compilaciÃ³n...$(NC)"
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

clean-cache:
	@echo "$(RED)ğŸ§¹ Limpiando cachÃ© de ccache...$(NC)"
	@ccache -C
	@ccache -z
	@echo "$(GREEN)âœ… CachÃ© limpiada y estadÃ­sticas reseteadas$(NC)"

# ============================================================================
# Ejecutar el juego
# ============================================================================
run: all
	@echo "$(GREEN)ğŸ® Ejecutando Chaos Crew...$(NC)"
	@echo ""
	@./$(TARGET)

# ============================================================================
# InformaciÃ³n del proyecto
# ============================================================================
info:
	@echo "$(YELLOW)Compilador:$(NC)     $(CXX)"
	@echo "$(YELLOW)Flags:$(NC)          $(CXXFLAGS) $(OPTFLAGS)"
	@echo "$(YELLOW)Archivos .cpp:$(NC)  $(words $(SOURCES))"
	@echo "$(YELLOW)Subdirectorios:$(NC) $(SRC_SUBDIRS)"
	@echo "$(YELLOW)Ejecutable:$(NC)     $(TARGET)"
	@echo "$(YELLOW)LibrerÃ­as:$(NC)      Raylib + EnTT (header-only)"
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(BLUE)ğŸ“Š EstadÃ­sticas ccache:$(NC)"
	@ccache -s | grep -E "(cache (hit|miss)|files in cache|cache size)" || echo "  ccache no disponible"
	@echo ""

# ============================================================================
# Listar archivos fuente detectados
# ============================================================================
list-sources:
	@echo "$(BLUE)ğŸ“„ Archivos fuente detectados:$(NC)"
	@for src in $(SOURCES); do \
		echo "  - $$src"; \
	done
	@echo ""
	@echo "$(YELLOW)Total: $(words $(SOURCES)) archivos$(NC)"

# ============================================================================
# InstalaciÃ³n del juego (copia a /usr/local/bin)
# ============================================================================
install: all
	@echo "$(BLUE)ğŸ“¦ Instalando Chaos Crew...$(NC)"
	@sudo install -d /usr/local/bin
	@sudo install -m 755 $(TARGET) /usr/local/bin/chaos-crew
	@echo "$(GREEN)âœ… Chaos Crew instalado en /usr/local/bin/chaos-crew$(NC)"
	@echo "$(CYAN)Ejecutar con: chaos-crew$(NC)"

uninstall:
	@echo "$(RED)ğŸ—‘ï¸  Desinstalando Chaos Crew...$(NC)"
	@sudo rm -f /usr/local/bin/chaos-crew
	@echo "$(GREEN)âœ… Chaos Crew desinstalado$(NC)"







# ============================================================================
# Testing (preparado para futura integraciÃ³n)
# ============================================================================
test:
	@echo "$(YELLOW)âš ï¸  Suite de tests aÃºn no implementada$(NC)"
	@echo "$(CYAN)TODO: Integrar GoogleTest o Catch2$(NC)"

# ============================================================================
# Benchmark de compilaciÃ³n
# ============================================================================
benchmark:
	@echo "$(BLUE)â±ï¸  Benchmark de compilaciÃ³n...$(NC)"
	@echo ""
	@echo "$(YELLOW)CompilaciÃ³n secuencial:$(NC)"
	@make clean > /dev/null 2>&1
	@time make -j1 > /dev/null 2>&1
	@echo ""
	@echo "$(YELLOW)CompilaciÃ³n paralela (-j4):$(NC)"
	@make clean > /dev/null 2>&1
	@time make -j4 > /dev/null 2>&1
	@echo ""

# ============================================================================
# Ayuda
# ============================================================================
help:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘$(NC)     $(GREEN)Makefile de Chaos Crew - Comandos Disponibles$(NC)    $(CYAN)â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ CompilaciÃ³n:$(NC)"
	@echo "  make              - Compila el proyecto (optimizado)"
	@echo "  make -j4          - Compila en paralelo (4 threads)"
	@echo "  make debug        - Compila en modo debug"
	@echo "  make clean        - Limpia archivos de compilaciÃ³n"
	@echo "  make clean-cache  - Limpia cachÃ© de ccache"
	@echo ""
	@echo "$(YELLOW)ğŸ® EjecuciÃ³n:$(NC)"
	@echo "  make run          - Compila y ejecuta el juego"
	@echo ""
	@echo "$(YELLOW)â„¹ï¸  InformaciÃ³n:$(NC)"
	@echo "  make info         - Muestra informaciÃ³n del proyecto"
	@echo "  make check-dirs   - Verifica estructura de directorios"
	@echo "  make list-sources - Lista archivos fuente detectados"
	@echo "  make help         - Muestra esta ayuda"
	@echo ""
	@echo "$(YELLOW)ğŸ› ï¸  Utilidades:$(NC)"
	@echo "  make dev-deps     - Instala dependencias de desarrollo"
	@echo "  make install      - Instala el juego en el sistema"
	

# ============================================================================
# InformaciÃ³n adicional
# ============================================================================
.DEFAULT_GOAL := all


